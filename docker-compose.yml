version: "3.9"

services:
  mysql:
    image: swr.cn-north-4.myhuaweicloud.com/ddn-k8s/gcr.io/ml-pipeline/mysql:8.0.26
    container_name: tc-mysql
    command:
      - --default-authentication-plugin=mysql_native_password
      - --character-set-server=utf8mb4
      - --collation-server=utf8mb4_unicode_ci
    environment:
      - MYSQL_ROOT_PASSWORD=123456
      - MYSQL_DATABASE=thinkcalendar
      - MYSQL_ROOT_HOST=%
      - TZ=Asia/Shanghai
    healthcheck:
      test: ["CMD", "mysqladmin", "ping", "-h", "localhost", "-p123456"]
      interval: 5s
      timeout: 5s
      retries: 15
      start_period: 40s
    volumes:
      - ./deploy_docker/mysql:/var/lib/mysql

  migrate:
    image: thinking-calendar-backend:latest
    build:
      context: ./backend
      dockerfile: deploy/build/Dockerfile
      args:
        APP_ENV: prod
    environment:
      - APP_CONF=config/prod.yml
    depends_on:
      mysql:
        condition: service_healthy
    entrypoint: ["/bin/sh","-c"]
    command:
      - |
        until nc -z mysql 3306; do
          echo "waiting mysql..."
          sleep 2
        done
        exec ./migrate -conf config/prod.yml
    restart: "no"

  task:
    image: thinking-calendar-backend:latest
    build:
      context: ./backend
      dockerfile: deploy/build/Dockerfile
      args:
        APP_ENV: prod
    environment:
      - MODEL_API_KEY=${MODEL_API_KEY}
      - APP_CONF=config/prod.yml
      - APP_ENV=prod
    depends_on:
      mysql:
        condition: service_healthy
      migrate:
        condition: service_completed_successfully
    entrypoint: ["./task"]
    command: ["-conf", "config/prod.yml"]
    restart: unless-stopped

  backend:
    image: thinking-calendar-backend:latest
    build:
      context: ./backend
      dockerfile: deploy/build/Dockerfile
      args:
        APP_ENV: prod
    environment:
      - MODEL_API_KEY={MODEL_API_KEY}
      - APP_CONF=config/prod.yml
      - APP_ENV=prod
    depends_on:
      mysql:
        condition: service_healthy
      migrate:
        condition: service_completed_successfully
    volumes:
      - ./deploy_docker/backend/logs:/data/app/storage/logs
    restart: unless-stopped

  frontend:
    image: thinking-calendar-frontend:latest
    build:
      context: ./frontend
      dockerfile: Dockerfile
      args:
        BACKEND_BASE: http://backend:8998/v1
        NEXT_PUBLIC_API_BASE_URL: /api
        NEXT_PUBLIC_API_MOCKING: disabled
    depends_on:
      backend:
        condition: service_started
    ports:
      - "3000:3000"
    restart: unless-stopped
